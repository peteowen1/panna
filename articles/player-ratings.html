<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Player Ratings Methodology • panna</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Player Ratings Methodology">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">panna</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/pipeline-walkthrough.html">Pipeline Walkthrough</a></li>
    <li><a class="dropdown-item" href="../articles/player-ratings.html">Player Ratings Methodology</a></li>
    <li><a class="dropdown-item" href="../articles/data-sources.html">Data Sources Guide</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/peteowen1/panna/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Player Ratings Methodology</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/peteowen1/panna/blob/main/vignettes/player-ratings.Rmd" class="external-link"><code>vignettes/player-ratings.Rmd</code></a></small>
      <div class="d-none name"><code>player-ratings.Rmd</code></div>
    </div>

    
    
<p>This vignette explains the RAPM, SPM, and Panna rating methodologies
used in the package.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Panna ratings measure player impact on team performance using a
three-stage approach:</p>
<ol style="list-style-type: decimal">
<li>
<strong>RAPM</strong> (Regularized Adjusted Plus-Minus) -
Lineup-based impact measurement</li>
<li>
<strong>SPM</strong> (Statistical Plus-Minus) - Box score prediction
of RAPM</li>
<li>
<strong>Panna</strong> - RAPM with SPM as a Bayesian prior</li>
</ol>
<p>All ratings are expressed as <strong>xG per 90 minutes above/below
average</strong>.</p>
</div>
<div class="section level2">
<h2 id="stage-1-rapm-regularized-adjusted-plus-minus">Stage 1: RAPM (Regularized Adjusted Plus-Minus)<a class="anchor" aria-label="anchor" href="#stage-1-rapm-regularized-adjusted-plus-minus"></a>
</h2>
<div class="section level3">
<h3 id="what-is-rapm">What is RAPM?<a class="anchor" aria-label="anchor" href="#what-is-rapm"></a>
</h3>
<p>RAPM isolates individual player contributions by analyzing lineup
combinations. It answers: “How much does having Player X on the field
change the team’s expected goal differential?”</p>
</div>
<div class="section level3">
<h3 id="splints">Splints<a class="anchor" aria-label="anchor" href="#splints"></a>
</h3>
<p>RAPM uses “splints” - time segments where the lineup is constant.
Splint boundaries are created at:</p>
<ul>
<li>Goals scored</li>
<li>Substitutions</li>
<li>Red cards</li>
<li>Halftime</li>
</ul>
<p>Each splint has approximately 22 players (11 per team) and records
the non-penalty xG differential (npxGD) during that segment.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/peteowen1/panna" class="external-link">panna</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># After loading processed data...</span></span>
<span><span class="va">splints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_all_splints.html">create_all_splints</a></span><span class="op">(</span><span class="va">processed_data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="design-matrix">Design Matrix<a class="anchor" aria-label="anchor" href="#design-matrix"></a>
</h3>
<p>The RAPM model uses a sparse design matrix where:</p>
<ul>
<li>
<strong>Rows</strong>: 2 per splint (one from each team’s attacking
perspective)</li>
<li>
<strong>Player columns</strong>: <code>playerX_off</code>
(offensive) and <code>playerX_def</code> (defensive) indicators</li>
<li>
<strong>Covariates</strong>: Goal difference, average minute,
home/away, player counts</li>
<li>
<strong>Target</strong>: xG FOR per 90 minutes
(<code>xgf90</code>)</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build the design matrix</span></span>
<span><span class="va">rapm_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_rapm_design_matrix.html">create_rapm_design_matrix</a></span><span class="op">(</span><span class="va">splints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Components:</span></span>
<span><span class="co"># - X_players: Sparse player indicator matrix</span></span>
<span><span class="co"># - X_full: Player indicators + covariates</span></span>
<span><span class="co"># - y: Target variable (xgf90)</span></span>
<span><span class="co"># - weights: Splint duration / 90</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ridge-regression">Ridge Regression<a class="anchor" aria-label="anchor" href="#ridge-regression"></a>
</h3>
<p>RAPM uses ridge regression (L2 penalty) with cross-validated lambda
to prevent overfitting:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit the model</span></span>
<span><span class="va">rapm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rapm.html">fit_rapm</a></span><span class="op">(</span><span class="va">rapm_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract player ratings</span></span>
<span><span class="va">ratings</span> <span class="op">&lt;-</span> <span class="fu">extract_panna_ratings</span><span class="op">(</span><span class="va">rapm_results</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="offensive-vs-defensive-ratings">Offensive vs Defensive Ratings<a class="anchor" aria-label="anchor" href="#offensive-vs-defensive-ratings"></a>
</h3>
<p>Each player gets two coefficients:</p>
<ul>
<li>
<strong>Offense coefficient</strong>: Player’s impact when their
team is attacking
<ul>
<li>Positive = helps create xG (good)</li>
<li>Negative = hurts attack (bad)</li>
</ul>
</li>
<li>
<strong>Defense coefficient</strong>: Player’s impact when their
team is defending
<ul>
<li>Positive = allows xG against (bad)</li>
<li>Negative = prevents xG (good)</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="stage-2-spm-statistical-plus-minus">Stage 2: SPM (Statistical Plus-Minus)<a class="anchor" aria-label="anchor" href="#stage-2-spm-statistical-plus-minus"></a>
</h2>
<div class="section level3">
<h3 id="what-is-spm">What is SPM?<a class="anchor" aria-label="anchor" href="#what-is-spm"></a>
</h3>
<p>SPM predicts RAPM ratings from box score statistics. It answers:
“What RAPM should we expect given a player’s traditional stats?”</p>
<p>This serves two purposes:</p>
<ol style="list-style-type: decimal">
<li>Provides ratings for players with insufficient RAPM sample size</li>
<li>Acts as a prior to stabilize RAPM estimates</li>
</ol>
</div>
<div class="section level3">
<h3 id="model">Model<a class="anchor" aria-label="anchor" href="#model"></a>
</h3>
<p>SPM uses elastic net regression to predict RAPM from aggregated
per-90 statistics:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregate box score stats to per-90 rates</span></span>
<span><span class="va">player_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_player_stats.html">aggregate_player_stats</a></span><span class="op">(</span><span class="va">processed_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit SPM model</span></span>
<span><span class="va">spm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_spm_model.html">fit_spm_model</a></span><span class="op">(</span><span class="va">player_stats</span>, <span class="va">rapm_ratings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get SPM ratings for all players</span></span>
<span><span class="va">spm_ratings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_spm_ratings.html">calculate_spm_ratings</a></span><span class="op">(</span><span class="va">spm_results</span>, <span class="va">player_stats</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="features-used">Features Used<a class="anchor" aria-label="anchor" href="#features-used"></a>
</h3>
<p>SPM uses statistics like:</p>
<ul>
<li>Goals, assists, xG, xA per 90</li>
<li>Pass completion rates</li>
<li>Tackles, interceptions, blocks per 90</li>
<li>Progressive passes and carries per 90</li>
<li>Aerial duel win rates</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="stage-3-panna-rating">Stage 3: Panna Rating<a class="anchor" aria-label="anchor" href="#stage-3-panna-rating"></a>
</h2>
<div class="section level3">
<h3 id="combining-rapm-and-spm">Combining RAPM and SPM<a class="anchor" aria-label="anchor" href="#combining-rapm-and-spm"></a>
</h3>
<p>The final Panna rating uses SPM as a Bayesian prior for RAPM:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit RAPM with SPM prior (xRAPM)</span></span>
<span><span class="va">xrapm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rapm_with_prior.html">fit_rapm_with_prior</a></span><span class="op">(</span><span class="va">rapm_data</span>, <span class="va">spm_ratings</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Final ratings</span></span>
<span><span class="va">panna_ratings</span> <span class="op">&lt;-</span> <span class="fu">extract_panna_ratings</span><span class="op">(</span><span class="va">xrapm_results</span><span class="op">)</span></span></code></pre></div>
<p>This approach:</p>
<ul>
<li>Shrinks noisy RAPM estimates toward SPM predictions</li>
<li>Gives more weight to RAPM for players with more minutes</li>
<li>Provides stable ratings even for players with limited data</li>
</ul>
</div>
<div class="section level3">
<h3 id="final-rating-calculation">Final Rating Calculation<a class="anchor" aria-label="anchor" href="#final-rating-calculation"></a>
</h3>
<pre><code><span><span class="va">panna</span> <span class="op">=</span> <span class="va">offense</span> <span class="op">-</span> <span class="va">defense</span></span></code></pre>
<p>Where: - Higher offense = better (creates more xG) - Lower (more
negative) defense = better (prevents xG) - Higher overall panna = better
player</p>
</div>
</div>
<div class="section level2">
<h2 id="interpreting-ratings">Interpreting Ratings<a class="anchor" aria-label="anchor" href="#interpreting-ratings"></a>
</h2>
<div class="section level3">
<h3 id="example-elite-forward">Example: Elite Forward<a class="anchor" aria-label="anchor" href="#example-elite-forward"></a>
</h3>
<pre><code>Player: Erling Haaland
Offense: +0.15
Defense: +0.02
Panna: +0.13</code></pre>
<p>Interpretation: - Creates +0.15 xG/90 above average when attacking -
Allows +0.02 xG/90 when defending (slightly below average) - Overall
impact: +0.13 xG/90</p>
</div>
<div class="section level3">
<h3 id="example-elite-defender">Example: Elite Defender<a class="anchor" aria-label="anchor" href="#example-elite-defender"></a>
</h3>
<pre><code>Player: Virgil van Dijk
Offense: -0.02
Defense: -0.10
Panna: +0.08</code></pre>
<p>Interpretation: - Creates -0.02 xG/90 on offense (average) - Prevents
0.10 xG/90 on defense (excellent) - Overall impact: +0.08 xG/90</p>
</div>
<div class="section level3">
<h3 id="scale-reference">Scale Reference<a class="anchor" aria-label="anchor" href="#scale-reference"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Rating</th>
<th>Interpretation</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>+0.15+</td>
<td>Elite</td>
</tr>
<tr class="even">
<td>+0.10</td>
<td>Very good</td>
</tr>
<tr class="odd">
<td>+0.05</td>
<td>Above average</td>
</tr>
<tr class="even">
<td>0.00</td>
<td>Average</td>
</tr>
<tr class="odd">
<td>-0.05</td>
<td>Below average</td>
</tr>
<tr class="even">
<td>-0.10</td>
<td>Poor</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="running-the-full-pipeline">Running the Full Pipeline<a class="anchor" aria-label="anchor" href="#running-the-full-pipeline"></a>
</h2>
<p>The complete rating pipeline:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/peteowen1/panna" class="external-link">panna</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Load raw data</span></span>
<span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu">load_all_data</span><span class="op">(</span>leagues <span class="op">=</span> <span class="st">"ENG"</span>, seasons <span class="op">=</span> <span class="st">"2024-2025"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Process data</span></span>
<span><span class="va">processed_data</span> <span class="op">&lt;-</span> <span class="fu">process_raw_data</span><span class="op">(</span><span class="va">raw_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Create splints</span></span>
<span><span class="va">splints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_all_splints.html">create_all_splints</a></span><span class="op">(</span><span class="va">processed_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Build RAPM matrix</span></span>
<span><span class="va">rapm_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_rapm_design_matrix.html">create_rapm_design_matrix</a></span><span class="op">(</span><span class="va">splints</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Fit base RAPM</span></span>
<span><span class="va">rapm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rapm.html">fit_rapm</a></span><span class="op">(</span><span class="va">rapm_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 6. Fit SPM</span></span>
<span><span class="va">spm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_spm_model.html">fit_spm_model</a></span><span class="op">(</span><span class="va">processed_data</span>, <span class="va">rapm_results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 7. Fit xRAPM (RAPM with SPM prior)</span></span>
<span><span class="va">xrapm_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_rapm_with_prior.html">fit_rapm_with_prior</a></span><span class="op">(</span><span class="va">rapm_data</span>, <span class="va">spm_results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 8. Extract final ratings</span></span>
<span><span class="va">panna_ratings</span> <span class="op">&lt;-</span> <span class="fu">extract_panna_ratings</span><span class="op">(</span><span class="va">xrapm_results</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<div class="section level3">
<h3 id="sample-size">Sample Size<a class="anchor" aria-label="anchor" href="#sample-size"></a>
</h3>
<p>RAPM requires substantial playing time for reliable estimates.
Recommended minimums:</p>
<ul>
<li>
<strong>Exploratory analysis</strong>: 450+ minutes</li>
<li>
<strong>Reliable estimates</strong>: 900+ minutes</li>
<li>
<strong>Stable comparisons</strong>: 1800+ minutes</li>
</ul>
</div>
<div class="section level3">
<h3 id="context-dependence">Context Dependence<a class="anchor" aria-label="anchor" href="#context-dependence"></a>
</h3>
<p>Ratings are relative to: - The players they shared the field with -
The opponents they faced - The leagues/seasons included in the model</p>
</div>
<div class="section level3">
<h3 id="position-blindness">Position Blindness<a class="anchor" aria-label="anchor" href="#position-blindness"></a>
</h3>
<p>RAPM doesn’t know player positions. A midfielder and striker with
identical lineups would have identical ratings, even if their roles
differ.</p>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>
<a href="getting-started.html">Getting Started</a> - Installation
and data loading</li>
<li>
<a href="data-sources.html">Data Sources</a> - FBref vs Opta vs
Understat</li>
<li>
<a href="../DATA_DICTIONARY.html">Data Dictionary</a> - Column
definitions at each pipeline stage</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pete Owen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
