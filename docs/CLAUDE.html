<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • panna</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"><meta property="og:image" content="https://peteowen1.github.io/panna/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">panna</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="articles/player-ratings.html">Player Ratings Methodology</a></li>
    <li><a class="dropdown-item" href="articles/data-sources.html">Data Sources Guide</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/peteowen1/panna/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/peteowen1/panna/blob/HEAD/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><code>panna</code> is an R package implementing player ratings for football (soccer) using the RAPM+SPM methodology. It calculates player impact on team performance using: - <strong>RAPM</strong> (Regularized Adjusted Plus-Minus) - lineup-based impact from splint-level data - <strong>SPM</strong> (Statistical Plus-Minus) - box score prediction of RAPM - <strong>Panna Rating</strong> - combines RAPM with SPM as Bayesian prior for stability</p>
<p>The package works with data from three sources via the <code>pannadata</code> repository and supports Big 5 European leagues.</p>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">load_all</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Load package for development</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">document</a></span><span class="op">(</span><span class="op">)</span>    <span class="co"># Generate documentation from roxygen2</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">test</a></span><span class="op">(</span><span class="op">)</span>        <span class="co"># Run all tests</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-utils.R"</span><span class="op">)</span>  <span class="co"># Run single test file</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">check</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># Full package check</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-sources">Data Sources<a class="anchor" aria-label="anchor" href="#data-sources"></a></h2>
<p>The package supports three football data sources with different strengths:</p>
<table class="table"><colgroup><col width="19%"><col width="23%"><col width="23%"><col width="33%"></colgroup><thead><tr><th>Source</th>
<th>Coverage</th>
<th>xG Model</th>
<th>Unique Stats</th>
</tr></thead><tbody><tr><td>FBref</td>
<td>Big 5 leagues + more</td>
<td>StatsBomb</td>
<td>Most comprehensive passing</td>
</tr><tr><td>Opta</td>
<td>Big 5 leagues (2010-present)</td>
<td>None</td>
<td>271 columns, progressive carries, set pieces</td>
</tr><tr><td>Understat</td>
<td>Big 5 + Russia</td>
<td>Understat model</td>
<td>xGChain, xGBuildup</td>
</tr></tbody></table><div class="section level3">
<h3 id="league-codes">League Codes<a class="anchor" aria-label="anchor" href="#league-codes"></a></h3>
<ul><li>
<strong>Panna codes</strong>: ENG, ESP, GER, ITA, FRA</li>
<li>
<strong>Opta codes</strong>: EPL, La_Liga, Bundesliga, Serie_A, Ligue_1</li>
<li>Season format: FBref uses “2024-2025”, Understat uses “2024”</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a></h2>
<p>When debugging R code, write a script to the <code>debug/</code> folder and run it from there rather than using inline Rscript commands. This avoids issues with escaping and segfaults from complex inline commands.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Write debug script to debug/test.R then run:</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>Rscript debug<span class="sc">/</span>test.R</span></code></pre></div>
<p>The <code>debug/</code> folder is gitignored.</p>
</div>
<div class="section level2">
<h2 id="coding-standards">Coding Standards<a class="anchor" aria-label="anchor" href="#coding-standards"></a></h2>
<div class="section level3">
<h3 id="column-naming">Column Naming<a class="anchor" aria-label="anchor" href="#column-naming"></a></h3>
<ul><li><strong>ALL column names must be snake_case</strong></li>
<li>Use <code><a href="https://sfirke.github.io/janitor/reference/clean_names.html" class="external-link">janitor::clean_names()</a></code> via <code><a href="reference/clean_column_names.html">clean_column_names()</a></code> helper</li>
<li>Apply to all data frames before saving or returning</li>
</ul></div>
<div class="section level3">
<h3 id="data-pipeline">Data Pipeline<a class="anchor" aria-label="anchor" href="#data-pipeline"></a></h3>
<ul><li>Package functions in <code>R/</code> - reusable, documented with roxygen2</li>
<li>Analysis scripts in <code>data-raw/</code> - sequential workflow (01_, 02_, etc.)</li>
<li>Cache expensive data to <code>data-raw/cache/</code>
</li>
<li>Analysis scripts run in RStudio - avoid excessive <code><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat()</a></code> calls, keep them simple</li>
</ul></div>
<div class="section level3">
<h3 id="pannadata-integration">pannadata Integration<a class="anchor" aria-label="anchor" href="#pannadata-integration"></a></h3>
<ul><li>Use <code><a href="reference/load_summary.html">panna::load_summary()</a></code>, <code><a href="reference/load_passing.html">load_passing()</a></code>, etc. to load cached match data</li>
<li>Data stored in <code>pannadata/data/{table_type}/{league}/{season}/{match_id}.rds</code>
</li>
<li>Column names are snake_case (via <code><a href="https://sfirke.github.io/janitor/reference/clean_names.html" class="external-link">janitor::clean_names()</a></code>)</li>
<li>See <code>pannadata/DATA_DICTIONARY.md</code> for column definitions</li>
<li>
<strong>DO NOT use worldfootballR</strong> - pannadata has its own FBref scraping system</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="core-data-flow">Core Data Flow<a class="anchor" aria-label="anchor" href="#core-data-flow"></a></h3>
<pre><code>pannadata (cached match data from FBref/Opta/Understat)
       ↓
01_load_pannadata.R (loads summary, passing, defense, possession, shots, metadata)
       ↓
02_data_processing.R → processed_data.rds (cleaned, standardized)
       ↓
03_splint_creation.R → splints.rds (time segments with constant lineups)
       ↓
04_rapm.R → rapm.rds (base RAPM) ──→ 05_spm.R → spm.rds (SPM model)
       ↓                                    ↓
06_xrapm.R → xrapm.rds (RAPM with SPM prior) ←┘
       ↓
07_seasonal_ratings.R → seasonal ratings
       ↓
08_panna_ratings.R → panna_ratings.csv (final ratings)</code></pre>
</div>
<div class="section level3">
<h3 id="key-concepts">Key Concepts<a class="anchor" aria-label="anchor" href="#key-concepts"></a></h3>
<p><strong>Splints</strong>: Time segments where the lineup is constant. Boundaries created at goals, substitutions, red cards, and halftime. Each splint has ~22 players (11 per team) and calculates npxGD (non-penalty xG differential).</p>
<p><strong>RAPM Design Matrix</strong>: - 2 rows per splint (home attacking perspective, away attacking perspective) - Player columns: <code>playerX_off</code> (offensive), <code>playerX_def</code> (defensive) - Covariates: goal_diff, goals_for/against, avg_minute, home/away, player counts - Target: <code>xgf90</code> (xG FOR per 90 minutes) - Uses ridge regression with cross-validated lambda</p>
<p><strong>Rating Interpretation</strong>: - Offense coefficient: positive = helps create xG (good) - Defense coefficient: positive = allows xG (bad), negative = prevents xG (good) - Final: <code>panna = offense - defense</code> (higher = better)</p>
</div>
<div class="section level3">
<h3 id="module-responsibilities">Module Responsibilities<a class="anchor" aria-label="anchor" href="#module-responsibilities"></a></h3>
<table class="table"><colgroup><col width="47%"><col width="52%"></colgroup><thead><tr><th>Module</th>
<th>Purpose</th>
</tr></thead><tbody><tr><td><code>data_loaders.R</code></td>
<td>DuckDB-based loading from local/remote parquet (FBref, Understat)</td>
</tr><tr><td><code>opta_loaders.R</code></td>
<td>Opta data loading with league code conversion</td>
</tr><tr><td><code>player_stats.R</code></td>
<td>User-facing aggregated stats functions (player_fbref_<em>, player_opta_</em>, player_understat_*)</td>
</tr><tr><td><code>piggyback.R</code></td>
<td>GitHub Releases upload/download (pb_upload_<em>, pb_download_</em>)</td>
</tr><tr><td><code>data_processing.R</code></td>
<td>Cleaning, standardization, merging</td>
</tr><tr><td><code>splint_creation.R</code></td>
<td>Time segment creation for RAPM</td>
</tr><tr><td><code>rapm_matrix.R</code></td>
<td>Design matrix construction</td>
</tr><tr><td><code>rapm_model.R</code></td>
<td>Ridge regression model fitting</td>
</tr><tr><td><code>spm_model.R</code></td>
<td>Box score prediction model</td>
</tr><tr><td><code>panna_rating.R</code></td>
<td>Final rating calculation</td>
</tr><tr><td><code>offensive_defensive.R</code></td>
<td>O/D rating decomposition</td>
</tr><tr><td><code>feature_engineering.R</code></td>
<td>Advanced feature creation (per-100 sequences)</td>
</tr><tr><td><code>utils.R</code></td>
<td>Helpers: clean_column_names, safe_divide, per_90, validate_seasons</td>
</tr><tr><td><code>globals.R</code></td>
<td>NSE variable declarations for R CMD check</td>
</tr></tbody></table></div>
</div>
<div class="section level2">
<h2 id="key-functions">Key Functions<a class="anchor" aria-label="anchor" href="#key-functions"></a></h2>
<div class="section level3">
<h3 id="data-loading-fbref-via-pannadata">Data Loading (FBref via pannadata)<a class="anchor" aria-label="anchor" href="#data-loading-fbref-via-pannadata"></a></h3>
<ul><li>
<code><a href="reference/load_summary.html">load_summary()</a></code>, <code><a href="reference/load_passing.html">load_passing()</a></code>, <code><a href="reference/load_defense.html">load_defense()</a></code>, <code><a href="reference/load_possession.html">load_possession()</a></code>, <code><a href="reference/load_shots.html">load_shots()</a></code>, <code><a href="reference/load_metadata.html">load_metadata()</a></code>
</li>
<li>Use <code>source = "remote"</code> (default) or <code>source = "local"</code>
</li>
</ul></div>
<div class="section level3">
<h3 id="data-loading-opta">Data Loading (Opta)<a class="anchor" aria-label="anchor" href="#data-loading-opta"></a></h3>
<ul><li>
<code><a href="reference/load_opta_stats.html">load_opta_stats()</a></code> - Player match stats (271 columns)</li>
<li>
<code><a href="reference/load_opta_shots.html">load_opta_shots()</a></code> - Shot data</li>
<li>
<code><a href="reference/load_opta_big5.html">load_opta_big5()</a></code> - All Big 5 leagues at once</li>
<li>
<code><a href="reference/pb_download_opta.html">pb_download_opta()</a></code> - Download Opta data from GitHub releases</li>
</ul></div>
<div class="section level3">
<h3 id="data-loading-understat">Data Loading (Understat)<a class="anchor" aria-label="anchor" href="#data-loading-understat"></a></h3>
<ul><li>
<code><a href="reference/load_understat_roster.html">load_understat_roster()</a></code> - Player stats with xGChain, xGBuildup</li>
<li>
<code><a href="reference/load_understat_shots.html">load_understat_shots()</a></code> - Shot-level data with xG</li>
<li>
<code><a href="reference/load_understat_metadata.html">load_understat_metadata()</a></code> - Match metadata</li>
</ul></div>
<div class="section level3">
<h3 id="player-statistics-user-facing-aggregations">Player Statistics (User-Facing Aggregations)<a class="anchor" aria-label="anchor" href="#player-statistics-user-facing-aggregations"></a></h3>
<ul><li>
<code><a href="reference/player_fbref_summary.html">player_fbref_summary()</a></code>, <code><a href="reference/player_fbref_passing.html">player_fbref_passing()</a></code>, <code><a href="reference/player_fbref_defense.html">player_fbref_defense()</a></code>, <code><a href="reference/player_fbref_keeper.html">player_fbref_keeper()</a></code>
</li>
<li>
<code><a href="reference/player_opta_summary.html">player_opta_summary()</a></code>, <code><a href="reference/player_opta_passing.html">player_opta_passing()</a></code>, <code><a href="reference/player_opta_defense.html">player_opta_defense()</a></code>, <code><a href="reference/player_opta_possession.html">player_opta_possession()</a></code>, <code><a href="reference/player_opta_keeper.html">player_opta_keeper()</a></code>, <code><a href="reference/player_opta_shots.html">player_opta_shots()</a></code>, <code><a href="reference/player_opta_setpiece.html">player_opta_setpiece()</a></code>
</li>
<li><code><a href="reference/player_understat_summary.html">player_understat_summary()</a></code></li>
</ul></div>
<div class="section level3">
<h3 id="splint-creation">Splint Creation<a class="anchor" aria-label="anchor" href="#splint-creation"></a></h3>
<ul><li>
<code><a href="reference/create_all_splints.html">create_all_splints()</a></code> - Master function for all matches</li>
<li>
<code><a href="reference/create_splint_boundaries.html">create_splint_boundaries()</a></code> - Define splint boundaries at events</li>
</ul></div>
<div class="section level3">
<h3 id="rapm">RAPM<a class="anchor" aria-label="anchor" href="#rapm"></a></h3>
<ul><li>
<code><a href="reference/create_rapm_design_matrix.html">create_rapm_design_matrix()</a></code> - Build X matrix with player/covariate columns</li>
<li>
<code><a href="reference/fit_rapm.html">fit_rapm()</a></code> - Fit cross-validated ridge regression</li>
<li>
<code>extract_panna_ratings()</code> - Extract player coefficients</li>
</ul></div>
<div class="section level3">
<h3 id="spm">SPM<a class="anchor" aria-label="anchor" href="#spm"></a></h3>
<ul><li>
<code><a href="reference/aggregate_player_stats.html">aggregate_player_stats()</a></code> - Convert match stats to per-90 rates</li>
<li>
<code><a href="reference/fit_spm_model.html">fit_spm_model()</a></code> - Elastic net predicting RAPM from box scores</li>
<li>
<code><a href="reference/calculate_spm_ratings.html">calculate_spm_ratings()</a></code> - Generate SPM for all players</li>
</ul></div>
<div class="section level3">
<h3 id="panna">Panna<a class="anchor" aria-label="anchor" href="#panna"></a></h3>
<ul><li>
<code><a href="reference/fit_panna_model.html">fit_panna_model()</a></code> - End-to-end pipeline combining RAPM + SPM</li>
<li>
<code><a href="reference/fit_rapm_with_prior.html">fit_rapm_with_prior()</a></code> - RAPM shrinking toward SPM (xRAPM)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="data-distribution-github-releases">Data Distribution (GitHub Releases)<a class="anchor" aria-label="anchor" href="#data-distribution-github-releases"></a></h2>
<p>Data is stored in GitHub Releases using tar.gz archives, organized by source:</p>
<table class="table"><colgroup><col width="40%"><col width="28%"><col width="31%"></colgroup><thead><tr><th>Release Tag</th>
<th>Archive</th>
<th>Contents</th>
</tr></thead><tbody><tr><td>fbref-latest</td>
<td>fbref-parquet.tar.gz</td>
<td>FBref parquet files</td>
</tr><tr><td>understat-latest</td>
<td>understat-parquet.tar.gz</td>
<td>Understat parquet files</td>
</tr><tr><td>opta-latest</td>
<td>opta_player_stats.parquet, opta_shots.parquet</td>
<td>Consolidated Opta files</td>
</tr></tbody></table><div class="section level3">
<h3 id="download-functions">Download Functions<a class="anchor" aria-label="anchor" href="#download-functions"></a></h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/pb_download_source.html">pb_download_source</a></span><span class="op">(</span><span class="st">"fbref"</span><span class="op">)</span>     <span class="co"># Download FBref data</span></span>
<span><span class="fu"><a href="reference/pb_download_source.html">pb_download_source</a></span><span class="op">(</span><span class="st">"understat"</span><span class="op">)</span> <span class="co"># Download Understat data</span></span>
<span><span class="fu"><a href="reference/pb_download_opta.html">pb_download_opta</a></span><span class="op">(</span><span class="op">)</span>              <span class="co"># Download Opta data (consolidated files)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="data-documentation">Data Documentation<a class="anchor" aria-label="anchor" href="#data-documentation"></a></h2>
<p>See <code>pannadata/DATA_DICTIONARY.md</code> for complete column definitions for raw data. See <code>panna/DATA_DICTIONARY.md</code> for processed data column definitions at each pipeline stage.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pete Owen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

