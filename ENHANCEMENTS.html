<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>EPV Enhancement Ideas • panna</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="EPV Enhancement Ideas"><meta property="og:image" content="https://peteowen1.github.io/panna/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">panna</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="articles/pipeline-walkthrough.html">Pipeline Walkthrough</a></li>
    <li><a class="dropdown-item" href="articles/player-ratings.html">Player Ratings Methodology</a></li>
    <li><a class="dropdown-item" href="articles/data-sources.html">Data Sources Guide</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/peteowen1/panna/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>EPV Enhancement Ideas</h1>
      <small class="dont-index">Source: <a href="https://github.com/peteowen1/panna/blob/main/ENHANCEMENTS.md" class="external-link"><code>ENHANCEMENTS.md</code></a></small>
    </div>

<div id="epv-enhancement-ideas" class="section level1">

<p>This file tracks potential improvements to the EPV (Expected Possession Value) model that require further research or significant implementation effort.</p>
<hr><div class="section level2">
<h2 id="opta-team-relative-coordinates-resolved">Opta Team-Relative Coordinates (RESOLVED)<a class="anchor" aria-label="anchor" href="#opta-team-relative-coordinates-resolved"></a></h2>
<p><strong>Status</strong>: Fixed in <code><a href="reference/convert_opta_to_spadl.html">convert_opta_to_spadl()</a></code> - default <code>normalize_direction = FALSE</code> <strong>Priority</strong>: Critical (was breaking coordinate continuity) <strong>Resolved</strong>: 2026-02</p>
<div class="section level3">
<h3 id="problem">Problem<a class="anchor" aria-label="anchor" href="#problem"></a></h3>
<p>Investigation revealed Opta uses <strong>team-relative coordinates</strong>: - Each team’s events are from THEIR OWN perspective - x=0 is the team’s own goal (defensive end) - x=100 is the opponent’s goal (attacking end) - Y coordinates are also team-relative (y=0 is one touchline from that team’s view)</p>
<p>This means a shot at (88, 30) by Team A and a save at (10.9, 70.6) by Team B are the <strong>same physical location</strong> from opposite perspectives (88+10.9≈100, 30+70.6≈100).</p>
<p>The original normalization logic tried to flip coordinates based on mean_x per team, but this doesn’t work with team-relative data since both teams naturally see themselves attacking toward x=100.</p>
</div>
<div class="section level3">
<h3 id="solution">Solution<a class="anchor" aria-label="anchor" href="#solution"></a></h3>
<p>Changed <code>normalize_direction = FALSE</code> as the default in <code><a href="reference/convert_opta_to_spadl.html">convert_opta_to_spadl()</a></code>.</p>
<p><strong>Why this is correct for EPV:</strong> - EPV models evaluate each action from the ball-carrier’s perspective - The ball-carrier always attacks toward x=100 in their native coordinates - At possession changes, the coordinate frame naturally changes (different perspective) - This discontinuity at possession changes is expected and correctly reflects the game state change</p>
<p><strong>Validation results with the fix:</strong> - Shots correctly at x=84 (mean) near attacking goal ✓ - Saves correctly at x=9 (mean) near defending goal ✓ - Same-team pass discontinuity: median 2.28 (low, as expected) ✓ - Different-team discontinuity: higher (expected, perspective change) ✓</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="opta-end_xend_y-data-issue-resolved">Opta end_x/end_y Data Issue (RESOLVED)<a class="anchor" aria-label="anchor" href="#opta-end_xend_y-data-issue-resolved"></a></h2>
<p><strong>Status</strong>: Fixed in <code><a href="reference/convert_opta_to_spadl.html">convert_opta_to_spadl()</a></code> <strong>Priority</strong>: Critical (was breaking EPV chain continuity) <strong>Resolved</strong>: 2026-02</p>
<div class="section level3">
<h3 id="problem-1">Problem<a class="anchor" aria-label="anchor" href="#problem-1"></a></h3>
<p>Analysis revealed that most Opta action types have <code>end_x=0, end_y=0</code> - only passes and clearances have proper end coordinates. This breaks EPV chain continuity where <code>end_x</code> of action N should match <code>start_x</code> of action N+1.</p>
<p><strong>Findings from <code>debug/analyze_spadl_continuity.R</code>:</strong></p>
<table class="table"><thead><tr class="header"><th>Action Type</th>
<th>end_x=0 %</th>
<th>Mean Gap</th>
<th>Notes</th>
</tr></thead><tbody><tr class="odd"><td>pass (1)</td>
<td>0%</td>
<td>2.79</td>
<td>✓ Proper coordinates</td>
</tr><tr class="even"><td>clearance (12)</td>
<td>14%</td>
<td>1.78</td>
<td>✓ Mostly proper coordinates</td>
</tr><tr class="odd"><td>tackle (7)</td>
<td>100%</td>
<td>39.05</td>
<td>Fixed: set end=start</td>
</tr><tr class="even"><td>interception (8)</td>
<td>100%</td>
<td>40.44</td>
<td>Fixed: set end=start</td>
</tr><tr class="odd"><td>ball_recovery (49)</td>
<td>100%</td>
<td>38.84</td>
<td>Fixed: set end=start</td>
</tr><tr class="even"><td>take_on (3)</td>
<td>100%</td>
<td>64.58</td>
<td>Fixed: set end=start</td>
</tr><tr class="odd"><td>ball_touch (61)</td>
<td>100%</td>
<td>52.22</td>
<td>Fixed: set end=start</td>
</tr><tr class="even"><td>aerial (44)</td>
<td>100%</td>
<td>51.53</td>
<td>Filtered (contested)</td>
</tr><tr class="odd"><td>dispossessed (50)</td>
<td>100%</td>
<td>53.46</td>
<td>Fixed: set end=start</td>
</tr><tr class="even"><td>keeper actions</td>
<td>100%</td>
<td>varies</td>
<td>Fixed: set end=start</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="solution-implemented">Solution Implemented<a class="anchor" aria-label="anchor" href="#solution-implemented"></a></h3>
<p>In <code><a href="reference/convert_opta_to_spadl.html">convert_opta_to_spadl()</a></code>:</p>
<ol style="list-style-type: decimal"><li>
<strong>Stationary actions</strong> (ball stays with player): Set <code>end_x = start_x, end_y = start_y</code>
<ul><li>tackle, interception, ball_recovery, ball_touch, take_on, foul, dispossessed</li>
<li>keeper_save, keeper_pick_up, keeper_claim, keeper_punch</li>
<li>
<strong>aerial</strong> (added to stationary list - duel winner keeps ball at their position)</li>
<li>clearance (fallback for rare data quality issues)</li>
</ul></li>
<li>
<strong>Duel row merging</strong>: Opta records both participants of a duel as separate rows
<ul><li>
<code><a href="reference/merge_duel_rows.html">merge_duel_rows()</a></code> combines these, keeping the winner’s row</li>
<li>Adds opponent info (opponent_player_id, opponent_player_name)</li>
<li>This avoids double-counting duel events</li>
</ul></li>
<li>
<strong>Actions with proper coordinates</strong>: Keep as-is
<ul><li>pass (type_id=1)</li>
<li>clearance (type_id=12) - usually has end coords</li>
</ul></li>
</ol><p>This ensures EPV chain continuity while preserving all meaningful actions including aerial duels.</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="aerial-duels-credit-assignment">Aerial Duels Credit Assignment<a class="anchor" aria-label="anchor" href="#aerial-duels-credit-assignment"></a></h2>
<p><strong>Status</strong>: Included (aerials treated as stationary actions with duel merging) <strong>Priority</strong>: Low (basic handling works) <strong>Complexity</strong>: Medium (for advanced credit assignment)</p>
<div class="section level3">
<h3 id="current-implementation">Current Implementation<a class="anchor" aria-label="anchor" href="#current-implementation"></a></h3>
<p>Aerials are now handled like other stationary actions: 1. <code>end_x = 0</code> issue fixed by setting <code>end = start</code> (winner keeps ball at their position) 2. Duel rows merged via <code><a href="reference/merge_duel_rows.html">merge_duel_rows()</a></code> - keeps winner’s row, removes loser’s 3. Winner gets EPV credit for what happens next; loser’s row is merged out</p>
<p>This is a reasonable approximation where the aerial winner gets credit proportional to the value they create with their subsequent action.</p>
</div>
<div class="section level3">
<h3 id="potential-enhancement">Potential Enhancement<a class="anchor" aria-label="anchor" href="#potential-enhancement"></a></h3>
<p>Aerials represent a unique opportunity for proper <strong>zero-sum credit assignment</strong>: 1. Both participants are recorded (winner and loser identified) 2. We could calculate a “contested baseline EPV” at that location 3. Winner credit: <code>(outcome_value - contested_baseline)</code> 4. Loser debit: <code>-(outcome_value - contested_baseline)</code></p>
<p>This would be one of the few cases where we properly assign <strong>negative credit</strong> to the losing player. Currently the loser gets no credit (their row is merged out) rather than negative credit.</p>
</div>
<div class="section level3">
<h3 id="research-needed-for-enhancement">Research Needed for Enhancement<a class="anchor" aria-label="anchor" href="#research-needed-for-enhancement"></a></h3>
<ul><li>Build model for “contested aerial baseline EPV” at different pitch locations</li>
<li>Validate that winner/loser credit sums to zero (zero-sum game)</li>
<li>Test whether explicit loser debit improves player ratings</li>
</ul></div>
<div class="section level3">
<h3 id="related-files">Related Files<a class="anchor" aria-label="anchor" href="#related-files"></a></h3>
<ul><li>
<code>R/spadl_conversion.R</code>: Handles aerials as stationary actions, merges duel rows</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="additional-enhancement-ideas">Additional Enhancement Ideas<a class="anchor" aria-label="anchor" href="#additional-enhancement-ideas"></a></h2>
<div class="section level3">
<h3 id="set-piece-valuation">Set Piece Valuation<a class="anchor" aria-label="anchor" href="#set-piece-valuation"></a></h3>
<p>Set pieces (corners, free kicks) have different EPV dynamics than open play. Consider: - Separate models for set piece situations - Credit assignment to set piece taker vs finisher</p>
</div>
<div class="section level3">
<h3 id="pressingcounterpressing-value">Pressing/Counterpressing Value<a class="anchor" aria-label="anchor" href="#pressingcounterpressing-value"></a></h3>
<p>Currently defensive actions get a flat 1.5x boost. Could model: - Time since possession loss (counterpress window) - Position-dependent defensive value - Chain of defensive actions (pressure sequences)</p>
</div>
<div class="section level3">
<h3 id="xg-integration-in-epv">xG Integration in EPV<a class="anchor" aria-label="anchor" href="#xg-integration-in-epv"></a></h3>
<p>The EPV model uses multinomial goal prediction. Could integrate: - Shot-level xG as terminal values (partially done for failed shots) - xG-based features for pre-shot actions</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="code-organization-large-file-splits">Code Organization: Large File Splits<a class="anchor" aria-label="anchor" href="#code-organization-large-file-splits"></a></h2>
<p><strong>Status</strong>: Recommended for v0.2.0 <strong>Priority</strong>: Medium (maintainability) <strong>Complexity</strong>: Medium (requires careful testing)</p>
<div class="section level3">
<h3 id="current-large-files">Current Large Files<a class="anchor" aria-label="anchor" href="#current-large-files"></a></h3>
<table class="table"><colgroup><col width="27%"><col width="31%"><col width="40%"></colgroup><thead><tr class="header"><th>File</th>
<th>Lines</th>
<th>Problem</th>
</tr></thead><tbody><tr class="odd"><td><code>scrape_fbref_direct.R</code></td>
<td>2028</td>
<td>Multiple concerns: HTTP, parsing, batching, data loading</td>
</tr><tr class="even"><td><code>spm_model.R</code></td>
<td>1690</td>
<td>FBref + Opta SPM combined, internal helpers mixed with exports</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="proposed-split-scrape_fbref_directr--4-files">Proposed Split: scrape_fbref_direct.R → 4 files<a class="anchor" aria-label="anchor" href="#proposed-split-scrape_fbref_directr--4-files"></a></h3>
<p><strong>1. <code>scrape_fbref_http.R</code> (~150 lines)</strong> - <code><a href="reference/get_fbref_headers.html">get_fbref_headers()</a></code> - Browser headers - <code><a href="reference/add_delay_jitter.html">add_delay_jitter()</a></code> - Request timing - <code><a href="reference/get_fbref_session.html">get_fbref_session()</a></code> - Session management - <code><a href="reference/reset_fbref_session.html">reset_fbref_session()</a></code> - Session reset - <code>check_fbref_status()</code> - Connection check - <code>.fbref_env</code> environment</p>
<p><strong>2. <code>scrape_fbref_pages.R</code> (~500 lines)</strong> - <code>fetch_fbref_page()</code> - Core page fetching - <code><a href="reference/fetch_with_retry.html">fetch_with_retry()</a></code> - Retry logic - <code>parse_match_tables()</code> - Table extraction - <code><a href="reference/extract_match_events.html">extract_match_events()</a></code> - Event parsing - <code>get_cached_path()</code> - Cache path utilities - <code><a href="reference/list_cached_matches.html">list_cached_matches()</a></code> - Cache listing</p>
<p><strong>3. <code>scrape_fbref_batch.R</code> (~600 lines)</strong> - <code><a href="reference/scrape_fixtures.html">scrape_fixtures()</a></code> - Fixture scraping - <code><a href="reference/scrape_fbref_matches.html">scrape_fbref_matches()</a></code> - Main batch scraper - <code><a href="reference/aggregate_cached_matches.html">aggregate_cached_matches()</a></code> - RDS aggregation - <code>rescrape_matches()</code> - Force rescrape</p>
<p><strong>4. <code>scrape_fbref_parquet.R</code> (~450 lines)</strong> - <code><a href="reference/build_parquet.html">build_parquet()</a></code> - Single parquet build - <code><a href="reference/build_consolidated_parquet.html">build_consolidated_parquet()</a></code> - Multi-league consolidation - <code><a href="reference/get_parquet_path.html">get_parquet_path()</a></code> - Path utilities - <code><a href="reference/migrate_metadata_tables_available.html">migrate_metadata_tables_available()</a></code> - Migration utilities</p>
<p><strong>Keep in <code>data_loaders.R</code></strong> (already exists): - <code><a href="reference/load_summary.html">load_summary()</a></code>, <code><a href="reference/load_passing.html">load_passing()</a></code>, etc. could be moved there - Currently uses DuckDB for remote parquet loading</p>
</div>
<div class="section level3">
<h3 id="proposed-split-spm_modelr--2-files">Proposed Split: spm_model.R → 2 files<a class="anchor" aria-label="anchor" href="#proposed-split-spm_modelr--2-files"></a></h3>
<p><strong>1. <code>spm_model.R</code> (~700 lines) - FBref SPM</strong> - Internal helpers: <code><a href="reference/dot-aggregate_stat_table.html">.aggregate_stat_table()</a></code>, <code>.get_*_col_mapping()</code> - <code><a href="reference/aggregate_player_stats.html">aggregate_player_stats()</a></code> - FBref aggregation - <code><a href="reference/fit_spm_model.html">fit_spm_model()</a></code> - Model fitting - <code><a href="reference/calculate_spm_ratings.html">calculate_spm_ratings()</a></code> - Rating extraction - <code>extract_spm_ratings()</code>, <code><a href="reference/compare_spm_features.html">compare_spm_features()</a></code></p>
<p><strong>2. <code>spm_opta.R</code> (~500 lines) - Opta SPM</strong> - <code><a href="reference/aggregate_opta_stats.html">aggregate_opta_stats()</a></code> - Opta aggregation (263 columns) - <code><a href="reference/fit_spm_opta.html">fit_spm_opta()</a></code> - Opta-specific model - <code><a href="reference/compare_spm_features.html">compare_spm_features()</a></code> - Feature comparison - Opta-specific column mappings and helpers</p>
</div>
<div class="section level3">
<h3 id="implementation-notes">Implementation Notes<a class="anchor" aria-label="anchor" href="#implementation-notes"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Source order matters</strong>: R loads files alphabetically, but <code>@importFrom</code> handles dependencies</li>
<li>
<strong>Internal functions</strong>: Use <code>@keywords internal</code> for helpers that stay in same file</li>
<li>
<strong>Namespace</strong>: Run <code>devtools::document()</code> after split to regenerate NAMESPACE</li>
<li>
<strong>Testing</strong>: Run <code>devtools::check()</code> and full test suite after split</li>
<li>
<strong>Git history</strong>: Consider <code>git mv</code> for better history tracking</li>
</ol></div>
<div class="section level3">
<h3 id="benefits">Benefits<a class="anchor" aria-label="anchor" href="#benefits"></a></h3>
<ul><li>Faster code navigation (smaller files)</li>
<li>Clearer responsibility boundaries</li>
<li>Easier testing of individual modules</li>
<li>Better parallelization of code review</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pete Owen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

